<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Edge-WebGL</title>
    <!-- Twitter Card data -->
    <meta name="twitter:card" value="Edge-GL Demo Rendering">
    <meta name="Description" content="Rendering demo of Edge-GL."/>
    <!-- Open Graph data -->
    <meta property="og:title" content="Edge-GL Demo Rendering" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://github.com/jedgeworth/WebGL-Terrain" />
    <meta property="og:image" content="https://jamesedgeworth.com/logo.svg" />
    <meta property="og:description" content="Rendering demo of Edge-GL." />
    <!-- Mobile header color for Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#ff4970">
    <!-- Mobile header color Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#ff4970">
    <!-- Mobile header color for iOS Safari (supports black, black-translucent or default) -->
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700" rel="stylesheet">

    <style>

        h3{
            margin:1rem 0 .5rem 0;
        }

        #glCanvas{
            position:absolute;
            top:0;
            left:0;
            right:0;
            bottom:0;
            width:100%;
            height:100%;
        }

        #debug{
            position:absolute;
            top:0;
            left:0;
            z-index:1;
        }

        #bottomLeft{
            position:absolute;
            bottom:0;
            left:0;
            padding:1rem;
            color:#fff;
            z-index:1;
        }

        #bottomRight{
            position:absolute;
            bottom:0;
            right:0;
            padding:1rem;
            background:#fff;
            z-index:1;
        }

        #topRight{
            position:absolute;
            top:0;
            right:0;
            width:150px;
            display:block;
            text-align:left;
            padding:1rem;
            z-index:1;
            background:#fff;
        }

        #cameraDebug{
            margin-top:1rem;
        }
    </style>

    <script id="base-vs" type="x-shader/x-vertex">
        attribute highp vec3 aVertexNormal;
        attribute highp vec3 aVertexPosition;
        attribute highp vec2 aTextureCoord;

        uniform highp vec3 uLight0Ambient;
        uniform highp vec3 uLight0Diffuse;
        uniform highp vec3 uLight0Specular;
        uniform highp vec3 uLight0Direction;

        uniform highp mat4 uNormalMatrix;
        uniform highp mat4 uMVMatrix;
        uniform highp mat4 uPMatrix;

        varying highp vec2 vTextureCoord;
        varying highp vec3 vLighting;

        void main(void) {
          gl_PointSize = 2.0;
          gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);

          vTextureCoord = aTextureCoord;

          highp vec4 transformedNormal = uNormalMatrix * vec4(aVertexNormal, 1.0);

          highp float directional = max(dot(transformedNormal.xyz, uLight0Direction), 0.0);
          vLighting = uLight0Ambient + (uLight0Diffuse * directional);
        }
    </script>

    <script id="base-fs" type="x-shader/x-fragment">
        varying highp vec2 vTextureCoord;
        varying highp vec3 vLighting;

        uniform sampler2D uSampler;

        void main(void) {
          highp vec4 texelColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));

          gl_FragColor = vec4(texelColor.rgb * vLighting, texelColor.a);
        }
    </script>

    <script id="base2-vs" type="x-shader/x-vertex">#version 100

        attribute highp vec3 aVertexNormal;
        attribute highp vec3 aVertexPosition;
        attribute highp vec2 aTextureCoord;

        uniform highp mat4 uNormalMatrix;
        uniform highp mat4 uMVMatrix;
        uniform highp mat4 uPMatrix;

        varying highp vec2 v_TextureCoord;
        varying highp vec3 v_VertexNormal;
        varying highp vec3 v_EyeVector;

        void main(void) {

            v_TextureCoord = aTextureCoord;
            v_VertexNormal = vec3( normalize( uNormalMatrix * vec4(aVertexNormal, 1.0) ) );

            v_EyeVector = vec3( normalize( -vec3(uMVMatrix * vec4(aVertexPosition, 1.0)) ) );

            gl_PointSize = 2.0;
            gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
        }
    </script>

    <script id="base2-fs" type="x-shader/x-fragment">#version 100

        varying highp vec2 v_TextureCoord;
        varying highp vec3 v_VertexNormal;
        varying highp vec3 v_EyeVector;

        uniform sampler2D uSampler;
        uniform highp vec3 uLight0Ambient;
        uniform highp vec3 uLight0Diffuse;
        uniform highp vec3 uLight0Specular;
        uniform highp vec3 uLight0Direction;

        highp vec4 lighting() {

            highp vec4 color;

            highp vec3 lightPosition = normalize(uLight0Direction.xyz);

            // If we have a normal map, get normal from that.
            highp vec3 normal = v_VertexNormal;

            // Ambient
            color = vec4(uLight0Ambient, 1.0);

            // Diffuse
            highp float vertexDiffuseValue = max( dot(normal, uLight0Direction), 0.0 );

            color += vertexDiffuseValue;

            // Specular
            highp float shininess = 0.5;

            highp vec3 reflectVector = normalize( -reflect(uLight0Direction, normal) );
            highp vec4 specular = vec4(uLight0Specular, 1.0) * pow(  max( dot(reflectVector, v_EyeVector.xyz), 0.0 ), shininess  );

            color += specular;

            return color;
        }

        void main(void) {
          highp vec4 texturing = texture2D(uSampler, vec2(v_TextureCoord.s, v_TextureCoord.t));

          //gl_FragColor = vec4(texelColor.rgb * vLighting, texelColor.a);
          gl_FragColor = texturing * lighting();
        }
    </script>


    <script id="line-vs" type="x-shader/x-vertex">
        attribute highp vec3 aVertexPosition;
        attribute highp vec3 aVertexColor;

        uniform highp mat4 uMVMatrix;
        uniform highp mat4 uPMatrix;

        varying highp vec3 vColor;

        void main(void) {
          gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
          vColor = aVertexColor;
        }
    </script>

    <script id="line-fs" type="x-shader/x-fragment">
        varying highp vec3 vColor;

        void main(void) {
          gl_FragColor = vec4(vColor.rgb, 1);
        }
    </script>


    <script id="terrain-vs" type="x-shader/x-vertex">
        varying vec3 vertexNormal;
        varying vec3 eyeVector;

        varying vec4 vertexPosition;

        varying vec4 mvmVertexPosition;
        varying vec4 mvpmVertexPosition;

        void main(void)
        {
            vertexNormal = normalize(gl_NormalMatrix * gl_Normal);

            //vertexLightPosition = normalize(gl_LightSource[0].position.xyz);
            eyeVector = normalize(-vec3(gl_ModelViewMatrix * gl_Vertex));

            gl_FrontColor = gl_Color;
            gl_TexCoord[0].st = gl_MultiTexCoord0.st;
            gl_Position = gl_ModelViewProjectionMatrix * gl_Vertex;
            vertexPosition = gl_Vertex;

            mvmVertexPosition = gl_ModelViewMatrix * gl_Vertex;
            mvpmVertexPosition = gl_ModelViewProjectionMatrix * gl_Vertex;
        }
    </script>

    <script id="terrain-fs" type="x-shader/x-fragment">

        varying vec3 vertexNormal;
        varying vec3 eyeVector;

        varying vec4 vertexPosition;

        uniform sampler2D grass;
        uniform sampler2D grassNormal;

        varying vec4 mvmVertexPosition;
        varying vec4 mvpmVertexPosition;

        vec4 lighting(int lightIndex)
        {
            vec4 color;

            vec3 lightPosition = normalize(gl_LightSource[lightIndex].position.xyz);

            vec3 fragmentNormal = normalize(texture2D(grassNormal, gl_TexCoord[0].st).rgb * 2.0 - 1.0);
            //vec3 normal = normalize(fragmentNormal * vertexNormal);
            vec3 normal = vertexNormal;
            //vec3 normal = fragmentNormal;

            color = gl_LightSource[lightIndex].ambient;

            // Diffuse
            float vertexDiffuseValue = max(dot(normal, lightPosition), 0.0);
            float fragmentDiffuseValue = max(dot(normal, lightPosition), 0.0);

            color += fragmentDiffuseValue;

            // Specular
            float shininess = 0.8;

            vec3 reflectVector = normalize(-reflect(lightPosition, normal));

            vec4 specular = gl_LightSource[lightIndex].specular * pow(max(dot(reflectVector, eyeVector), 0.0), shininess);

            color += specular;
            return color;
        }

        void main()
        {
            //if (dot(mvpmVertexPosition, gl_ClipPlane[0]) > 0.0) {
            //if (gl_Position.y > gl_ClipPlane[0].y) {

                vec4 texturing = texture2D(grass, gl_TexCoord[0].st);

                gl_FragColor = texturing * lighting(0);

            //} else {
            //    discard;
            //}
        }

    </script>

</head>
    <body>
        <div id="debug"></div>


        <div id="topRight">
            <h3>Render options</h3>
            <input type="radio" name="renderModeOverride" value="0" checked>
            <label for="renderModeOverride">Render default</label><br>

            <input type="radio" name="renderModeOverride" value="1">
            <label for="renderModeOverride">Render as lines</label><br>

            <input type="radio" name="renderModeOverride" value="2">
            <label for="renderModeOverride">Render as points</label><br>

            <h3>Sunlight</h3>

            <label>
                Diffuse R
                <input class="diffuse" type="range" min="0.0" max="1" step="0.01" id="diffuseR" name="diffuseR" value="0.7">
            </label>

            <label>
                Diffuse G
                <input class="diffuse" type="range" min="0.0" max="1" step="0.01"  id="diffuseG" name="diffuseG" value="0.7">
            </label>

            <label>
                Diffuse B
                <input class="diffuse" type="range" min="0.0" max="1" step="0.01"  id="diffuseB" name="diffuseB" value="0.7">
            </label>

            <label>
                Specular R
                <input class="specular" type="range" min="0.0" max="1" step="0.01"  id="specularR" name="specularR" value="0.6">
            </label>

            <label>
                Specular G
                <input class="specular" type="range" min="0.0" max="1" step="0.01"  id="specularG" name="specularG" value="0.6">
            </label>

            <label>
                Specular B
                <input class="specular" type="range" min="0.0" max="1" step="0.01"  id="specularB" name="specularB" value="0.6">
            </label>


            <div id="cameraDebug"></div>
        </div>

        <div id="bottomRight">
            Controls:
            <b>W,A,S,D</b> = movement;
            <b>Space,Q</b> = Up, Down;
            <b>Arrow keys</b> = rotation;
            <b>R, F</b> = Increment/decrement camera speed
        </div>

        <div id="bottomLeft">
            &copy; 2022 <a href="https://jamesedgeworth.com">James Edgeworth</a>
        </div>

        <canvas id="glcanvas" style="width:100%; height:100%">
            Your browser doesn't appear to support the HTML5 <code>&lt;canvas&gt;</code> element.
        </canvas>
    </body>
</html>
